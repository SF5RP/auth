# Nginx Configuration for User ServiceЭтот каталог содержит конфигурационные файлы Nginx для auth сервиса, адаптированные на основе конфигурации Casino Backend.## Файлы конфигурации### `user-service.conf`Базовая конфигурация для разработки и тестирования:- Умеренные ограничения по скорости запросов- Базовые заголовки безопасности- Простое логирование- Поддержка HTTP и HTTPS (закомментировано)### `user-service-prod.conf`Продакшн конфигурация с расширенными возможностями:- Строгие ограничения по скорости запросов- Расширенные заголовки безопасности- Подробное логирование- Gzip сжатие- SSL/TLS конфигурация- Защита от атак- Кэширование статических файлов## Основные улучшения по сравнению с оригинальной конфигурацией### 1. Архитектура сервисов- **Backend**: Один Go сервис на порту 8080 (настраивается через SERVER_PORT)- **Frontend**: Next.js приложение на порту 3000- **База данных**: PostgreSQL на порту 5432### 2. Специализированные зоны ограничения скорости- `api`: Общие API запросы (10 r/s для dev, 5 r/s для prod)- `login`: Логин (2 r/s для dev, 1 r/s для prod)- `callback`: OAuth callback (5 r/s для dev, 3 r/s для prod)- `admin`: Административные функции (5 r/s для dev, 2 r/s для prod)- `static`: Статические файлы (20 r/s для prod)- Content Security Policy (CSP)- Permissions Policy- Блокировка доступа к чувствительным файлам- Защита от распространенных атак- HSTS для HTTPS### 3. Оптимизация производительности- Gzip сжатие- Агрессивное кэширование статических файлов- Оптимизированные таймауты- Load balancing с health checks### 4. Мониторинг и логирование- Подробный формат логов- Отдельные логи для HTTP и HTTPS- Логирование времени ответа upstream серверов## Установка и настройка### Для разработки```bash# Скопировать конфигурациюsudo cp deploy/nginx/user-service.conf /etc/nginx/sites-available/# Включить сайтsudo ln -s /etc/nginx/sites-available/user-service.conf /etc/nginx/sites-enabled/# Проверить конфигурациюsudo nginx -t# Перезагрузить Nginxsudo systemctl reload nginx```### Для продакшна```bash# Скопировать продакшн конфигурациюsudo cp deploy/nginx/user-service-prod.conf /etc/nginx/sites-available/# Включить сайтsudo ln -s /etc/nginx/sites-available/user-service-prod.conf /etc/nginx/sites-enabled/# Получить SSL сертификат (Let's Encrypt)sudo certbot --nginx -d your-domain.com -d www.your-domain.com# Проверить конфигурациюsudo nginx -t# Перезагрузить Nginxsudo systemctl reload nginx```## Настройка доменаЗамените `your-domain.com` на ваш реальный домен в конфигурационных файлах:```bash# Заменить домен в конфигурацииsed -i 's/your-domain.com/your-actual-domain.com/g' /etc/nginx/sites-available/user-service.conf```## Мониторинг### Логи- HTTP: `/var/log/nginx/user-service.access.log`- HTTPS: `/var/log/nginx/user-service-ssl.access.log`- Ошибки: `/var/log/nginx/user-service.error.log`### Health Check```bash# Проверить статус сервисаcurl http://your-domain.com/health```### Статистика Nginx```bash# Показать активные соединенияsudo nginx -s status# Показать статистику upstream серверовcurl http://localhost/nginx_status```## Настройка upstream серверов### Добавление дополнительных серверовРаскомментируйте и настройте дополнительные серверы в секции `upstream`:```nginxupstream auth_backend {    server 127.0.0.1:8080 max_fails=3 fail_timeout=30s;    server 127.0.0.1:8081 max_fails=3 fail_timeout=30s;    server 127.0.0.1:8082 max_fails=3 fail_timeout=30s;}```### Health ChecksNginx автоматически проверяет доступность серверов и исключает недоступные из балансировки нагрузки.## Безопасность### Rate LimitingНастройки ограничения скорости можно изменить в секции `limit_req_zone`:```nginx# Увеличить лимит для APIlimit_req_zone $binary_remote_addr zone=api:10m rate=20r/s;```### Блокировка IPДобавьте в секцию `server`:```nginx# Блокировать конкретные IPlocation / {    deny 192.168.1.100;    deny 10.0.0.0/8;    # ... остальная конфигурация}```## Troubleshooting### Проверка конфигурации```bashsudo nginx -t```### Перезагрузка конфигурации```bashsudo systemctl reload nginx```### Просмотр ошибок```bashsudo tail -f /var/log/nginx/user-service.error.log```### Проверка статуса сервисов```bashsudo systemctl status nginxsudo systemctl status user-service```